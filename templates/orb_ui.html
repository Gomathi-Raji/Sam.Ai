<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zara AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000000;
            background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #orb-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        /* Main Orb */
        .orb {
            position: relative;
            width: 350px;
            height: 350px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, 
                rgba(100, 150, 255, 0.9), 
                rgba(50, 100, 220, 0.7), 
                rgba(20, 50, 180, 0.5));
            box-shadow: 
                0 0 100px rgba(100, 150, 255, 0.7),
                0 0 200px rgba(100, 150, 255, 0.5),
                0 0 300px rgba(100, 150, 255, 0.3),
                inset 0 0 100px rgba(150, 200, 255, 0.4);
            animation: float 4s ease-in-out infinite;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ready State - Blue */
        .orb.ready {
            background: radial-gradient(circle at 35% 35%, 
                rgba(100, 150, 255, 0.9), 
                rgba(50, 100, 220, 0.7), 
                rgba(20, 50, 180, 0.5));
            box-shadow: 
                0 0 100px rgba(100, 150, 255, 0.7),
                0 0 200px rgba(100, 150, 255, 0.5),
                0 0 300px rgba(100, 150, 255, 0.3),
                inset 0 0 100px rgba(150, 200, 255, 0.4);
            animation: float 4s ease-in-out infinite;
        }

        /* Listening State - Green */
        .orb.listening {
            width: 380px;
            height: 380px;
            background: radial-gradient(circle at 35% 35%, 
                rgba(50, 255, 150, 1), 
                rgba(30, 200, 120, 0.8), 
                rgba(10, 150, 90, 0.6));
            box-shadow: 
                0 0 120px rgba(50, 255, 150, 0.9),
                0 0 240px rgba(50, 255, 150, 0.7),
                0 0 360px rgba(50, 255, 150, 0.5),
                inset 0 0 120px rgba(100, 255, 180, 0.5);
            animation: pulse-listening 1.2s ease-in-out infinite;
        }

        /* Speaking State - Red/Orange */
        .orb.speaking {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle at 35% 35%, 
                rgba(255, 120, 80, 1), 
                rgba(220, 80, 50, 0.9), 
                rgba(180, 40, 20, 0.7));
            box-shadow: 
                0 0 130px rgba(255, 120, 80, 0.95),
                0 0 260px rgba(255, 120, 80, 0.8),
                0 0 390px rgba(255, 120, 80, 0.6),
                inset 0 0 130px rgba(255, 160, 120, 0.6);
            animation: pulse-speaking 0.6s ease-in-out infinite;
        }

        /* Processing State - Purple */
        .orb.processing {
            width: 370px;
            height: 370px;
            background: radial-gradient(circle at 35% 35%, 
                rgba(180, 100, 255, 1), 
                rgba(140, 70, 220, 0.8), 
                rgba(100, 40, 180, 0.6));
            box-shadow: 
                0 0 110px rgba(180, 100, 255, 0.85),
                0 0 220px rgba(180, 100, 255, 0.65),
                0 0 330px rgba(180, 100, 255, 0.45),
                inset 0 0 110px rgba(200, 140, 255, 0.5);
            animation: pulse-processing 0.9s ease-in-out infinite;
        }

        /* Animations */
        @keyframes float {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-25px) scale(1.03);
            }
        }

        @keyframes pulse-listening {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.12);
                filter: brightness(1.2);
            }
        }

        @keyframes pulse-speaking {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1) saturate(1);
            }
            25% {
                transform: scale(1.15);
                filter: brightness(1.3) saturate(1.2);
            }
            75% {
                transform: scale(1.08);
                filter: brightness(1.1) saturate(1.1);
            }
        }

        @keyframes pulse-processing {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.08) rotate(180deg);
                filter: brightness(1.15);
            }
        }

        /* Glow effect layer */
        .orb::before {
            content: '';
            position: absolute;
            top: -15%;
            left: -15%;
            right: -15%;
            bottom: -15%;
            border-radius: 50%;
            background: inherit;
            filter: blur(50px);
            opacity: 0.6;
            z-index: -1;
        }

        /* Outer ripple effect */
        .orb::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: ripple 4s ease-out infinite;
        }

        @keyframes ripple {
            0% {
                width: 100%;
                height: 100%;
                opacity: 0.9;
            }
            100% {
                width: 250%;
                height: 250%;
                opacity: 0;
            }
        }

        /* Start button for first-time audio permission */
        .start-button {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background: rgba(100, 150, 255, 0.9);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(100, 150, 255, 0.6);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .start-button.show {
            opacity: 1;
            pointer-events: all;
        }

        .start-button:hover {
            background: rgba(120, 170, 255, 1);
            transform: translate(-50%, -50%) scale(1.05);
        }

        .start-button:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        /* Inner highlight */
        .orb-inner {
            position: absolute;
            top: 15%;
            left: 15%;
            width: 40%;
            height: 40%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, 
                rgba(255, 255, 255, 0.4),
                rgba(255, 255, 255, 0.1),
                transparent);
            filter: blur(10px);
        }

        /* Particles container */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: particle-float 8s infinite ease-in-out;
        }

        @keyframes particle-float {
            0%, 100% {
                transform: translate(0, 0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="orb-container">
        <div class="orb ready" id="orb">
            <div class="orb-inner"></div>
        </div>
    </div>

    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>

    <!-- Start button for first-time audio activation -->
    <button class="start-button show" id="startButton">
        ðŸŽ¤ Tap to Start Zara
    </button>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Create ambient particles
        const particlesContainer = document.getElementById('particles');
        const particleCount = 30;

        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random starting position
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            
            // Random animation duration and delay
            particle.style.animationDuration = (8 + Math.random() * 8) + 's';
            particle.style.animationDelay = Math.random() * 8 + 's';
            
            // Random movement
            particle.style.setProperty('--tx', (Math.random() - 0.5) * 400 + 'px');
            particle.style.setProperty('--ty', (Math.random() - 0.5) * 400 + 'px');
            
            particlesContainer.appendChild(particle);
        }

        // WebSocket connection
        const socket = io();
        const orb = document.getElementById('orb');

        // Browser-based Speech Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let isProcessing = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ta-IN'; // Tamil

            recognition.onstart = () => {
                console.log('ðŸŽ¤ Browser listening started');
                isListening = true;
                socket.emit('browser_state', { state: 'listening' });
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('ðŸ“ Heard:', transcript);
                isListening = false;
                isProcessing = true;
                
                // Send command to server
                socket.emit('voice_command', { command: transcript });
            };

            recognition.onerror = (event) => {
                console.error('âŒ Speech recognition error:', event.error);
                isListening = false;
                isProcessing = false;
                
                // Restart listening after error
                setTimeout(() => {
                    if (!isProcessing) {
                        startListening();
                    }
                }, 2000);
            };

            recognition.onend = () => {
                console.log('ðŸ”´ Browser listening ended');
                isListening = false;
                
                // Auto-restart listening if not processing
                if (!isProcessing) {
                    setTimeout(() => {
                        startListening();
                    }, 1000);
                }
            };
        } else {
            console.error('âŒ Speech Recognition not supported in this browser');
            alert('Speech Recognition not supported. Please use Chrome or Edge on your phone.');
        }

        function startListening() {
            if (recognition && !isListening && !isProcessing) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition already started or error:', e);
                }
            }
        }

        // Handle state changes from server
        socket.on('state_change', (data) => {
            const state = data.state;
            console.log('ðŸ”„ State changed to:', state);
            
            // Remove all state classes
            orb.classList.remove('ready', 'listening', 'speaking', 'processing');
            
            // Add new state class
            orb.classList.add(state);

            // Control listening based on state
            if (state === 'ready') {
                isProcessing = false;
                // Start listening after a short delay
                setTimeout(() => {
                    startListening();
                }, 1500);
            } else if (state === 'speaking' || state === 'processing') {
                isProcessing = true;
                // Stop listening while AI is speaking/processing
                if (recognition && isListening) {
                    try {
                        recognition.stop();
                    } catch (e) {
                        console.log('Error stopping recognition:', e);
                    }
                }
            }
        });

        // Handle audio playback from server
        socket.on('play_audio', (data) => {
            console.log('ðŸ”Š Playing audio from server');
            const audio = new Audio('data:audio/mp3;base64,' + data.audio);
            audio.play().catch(e => console.error('Audio playback error:', e));
        });

        // Handle text-to-speech from server
        socket.on('speak_text', (data) => {
            const text = data.text;
            console.log('ðŸ—£ï¸ Speaking text:', text);

            // Use browser's built-in speech synthesis
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ta-IN'; // Tamil
                utterance.rate = 0.9; // Slightly slower for clarity
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // Find a Tamil voice if available
                const voices = speechSynthesis.getVoices();
                const tamilVoice = voices.find(voice =>
                    voice.lang.includes('ta') || voice.lang.includes('hi')
                );
                if (tamilVoice) {
                    utterance.voice = tamilVoice;
                    console.log('ðŸŽ¤ Using voice:', tamilVoice.name);
                } else {
                    console.log('âš ï¸ No Tamil voice found, using default');
                }

                utterance.onstart = () => {
                    console.log('ðŸ”Š Speech started');
                };

                utterance.onend = () => {
                    console.log('ðŸ”‡ Speech ended');
                };

                utterance.onerror = (event) => {
                    console.error('âŒ Speech error:', event.error);
                };

                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                // Speak
                speechSynthesis.speak(utterance);
            } else {
                console.warn('âš ï¸ Speech synthesis not supported in this browser');
                // Fallback: show text in console
                console.log('Response:', text);
            }
        });

        // Connection events
        socket.on('connect', () => {
            console.log('âœ… Connected to Zara AI server');
            
            // Wait a bit for voices to load
            setTimeout(() => {
                // Load voices
                if ('speechSynthesis' in window) {
                    speechSynthesis.getVoices();
                }
                
                // Start listening after connection
                setTimeout(() => {
                    startListening();
                }, 2000);
            }, 500);
        });

        socket.on('disconnect', () => {
            console.log('âŒ Disconnected from server');
            isProcessing = false;
            isListening = false;
        });

        // Click to manually trigger listening
        orb.addEventListener('click', () => {
            console.log('ðŸ‘† Orb clicked - Current state:', orb.className);
            if (!isListening && !isProcessing) {
                startListening();
            }
        });

        // Auto-start on page load
        window.addEventListener('load', () => {
            console.log('ðŸ“± Page loaded - Waiting for connection...');
            
            // Load voices
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => {
                    const voices = speechSynthesis.getVoices();
                    console.log(`ðŸŽ¤ Loaded ${voices.length} voices`);
                    voices.forEach((voice, i) => {
                        if (voice.lang.includes('ta') || voice.lang.includes('hi') || voice.lang.includes('en')) {
                            console.log(`  ${i}: ${voice.name} (${voice.lang})`);
                        }
                    });
                };
            }
        });

        // Start button handler
        const startButton = document.getElementById('startButton');
        let hasStarted = false;

        startButton.addEventListener('click', () => {
            if (!hasStarted) {
                hasStarted = true;
                console.log('ðŸš€ User activated Zara');
                
                // Hide button
                startButton.classList.remove('show');
                
                // Test speech synthesis
                if ('speechSynthesis' in window) {
                    const testUtterance = new SpeechSynthesisUtterance('à®µà®£à®•à¯à®•à®®à¯');
                    testUtterance.lang = 'ta-IN';
                    testUtterance.volume = 1.0;
                    speechSynthesis.speak(testUtterance);
                }
                
                // Start listening
                setTimeout(() => {
                    startListening();
                }, 1000);
            }
        });
    </script>
</body>
</html>
